# QLCapsule Download and Inspection Guide

This guide explains how to download, inspect, and work with QLCapsules stored in the database.

## Overview

QLCapsules are complete software packages generated by the Quantum Layer Platform. Each capsule contains:
- Source code files
- Test suites
- Documentation
- Deployment configurations
- Validation reports
- Metadata

## Methods to Access Capsules

### 1. Command Line Tool (`download_capsule.py`)

The easiest way to work with capsules is using the command-line tool.

#### List Available Capsules
```bash
python download_capsule.py list
```

Shows the most recent capsules with their IDs, names, and basic info:
```
üì¶ Available Capsules (showing 10 of 10 max):
================================================================================

üÜî ID: capsule-12345-abcd-efgh
   üìã Name: E-Commerce Order Management API
   üíª Language: python | Framework: fastapi
   üìÖ Created: 2025-07-11T12:34:56Z
   üìÅ Files: 12 source, 8 tests
```

#### Download a Capsule

**As ZIP file (default):**
```bash
python download_capsule.py download capsule-12345-abcd-efgh
```

**As TAR.GZ file:**
```bash
python download_capsule.py download capsule-12345-abcd-efgh --format tar
```

**Extract directly to directory:**
```bash
python download_capsule.py download capsule-12345-abcd-efgh --format directory --output ./my-project
```

#### Inspect Capsule Contents (without downloading)
```bash
python download_capsule.py inspect capsule-12345-abcd-efgh
```

This shows:
- Manifest details
- File listings with sizes
- Validation report summary
- Metadata and quality scores

#### Extract Specific Files
```bash
# View a file in console
python download_capsule.py extract capsule-12345-abcd-efgh main.py

# Save a file to disk
python download_capsule.py extract capsule-12345-abcd-efgh main.py --output ./extracted_main.py
```

### 2. REST API Endpoints

The orchestrator provides REST API endpoints for programmatic access.

#### List Capsules
```bash
curl http://localhost:8000/api/capsules?limit=10
```

#### Get Capsule Details
```bash
curl http://localhost:8000/api/capsules/capsule-12345-abcd-efgh
```

#### Download Capsule
```bash
# Download as ZIP
curl -O http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/download?format=zip

# Download as TAR.GZ
curl -O http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/download?format=tar.gz
```

#### Stream Large Capsules
```bash
# For very large capsules, use streaming
curl http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/stream > capsule.tar.gz
```

#### Get Specific File
```bash
curl http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/files/main.py
```

#### Export as Helm Chart
```bash
curl http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/export/helm > helm-chart.json
```

#### Export as Terraform
```bash
curl http://localhost:8000/api/capsules/capsule-12345-abcd-efgh/export/terraform > terraform-config.json
```

### 3. Direct Database Access

For advanced users who need direct database access:

```python
from src.orchestrator.capsule_storage import PostgresCapsuleStorage

async def get_capsule_from_db():
    storage = PostgresCapsuleStorage()
    
    # List capsules
    capsules = await storage.list_capsules(limit=10)
    
    # Get specific capsule
    capsule_data = await storage.get_capsule("capsule-12345-abcd-efgh")
    
    # Convert to QLCapsule model
    from src.common.models import QLCapsule
    capsule = QLCapsule(**capsule_data)
    
    # Access components
    print(f"Source files: {list(capsule.source_code.keys())}")
    print(f"Test files: {list(capsule.tests.keys())}")
    print(f"Documentation: {capsule.documentation[:100]}...")
```

## What's Inside a Downloaded Capsule?

When you download and extract a capsule, you'll find:

```
my-capsule/
‚îú‚îÄ‚îÄ manifest.json          # Project metadata
‚îú‚îÄ‚îÄ metadata.json          # Generation details
‚îú‚îÄ‚îÄ validation_report.json # Quality checks
‚îú‚îÄ‚îÄ deployment_config.json # Deployment settings
‚îú‚îÄ‚îÄ README.md              # Documentation
‚îú‚îÄ‚îÄ main.py                # Application code
‚îú‚îÄ‚îÄ requirements.txt       # Dependencies
‚îú‚îÄ‚îÄ Dockerfile             # Container config
‚îú‚îÄ‚îÄ docker-compose.yml     # Multi-container setup
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ test_main.py      # Unit tests
‚îÇ   ‚îú‚îÄ‚îÄ test_integration.py
‚îÇ   ‚îî‚îÄ‚îÄ conftest.py
‚îú‚îÄ‚îÄ .github/
‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îî‚îÄ‚îÄ ci.yml        # CI/CD pipeline
‚îî‚îÄ‚îÄ kubernetes/           # K8s manifests (if applicable)
```

## Common Use Cases

### 1. Deploy a Capsule to Production

```bash
# Download and extract
python download_capsule.py download capsule-id --format directory -o ./my-app

# Navigate to directory
cd my-app

# Build and run with Docker
docker-compose up --build

# Or deploy to Kubernetes
kubectl apply -f kubernetes/
```

### 2. Integrate Capsule into Existing Project

```bash
# Extract specific files you need
python download_capsule.py extract capsule-id main.py -o ./src/api.py
python download_capsule.py extract capsule-id tests/test_main.py -o ./tests/test_api.py
```

### 3. Analyze Multiple Capsules

```python
import asyncio
from download_capsule import CapsuleDownloader

async def analyze_capsules():
    downloader = CapsuleDownloader()
    
    # List recent capsules
    await downloader.list_capsules(limit=20)
    
    # Inspect each one
    capsule_ids = ["id1", "id2", "id3"]
    for capsule_id in capsule_ids:
        await downloader.inspect_capsule(capsule_id)

asyncio.run(analyze_capsules())
```

### 4. Quality Check Before Deployment

```bash
# First, run the critique
curl -X POST http://localhost:8000/api/critique/capsule-id

# Then download if quality is good
python download_capsule.py download capsule-id
```

## File Access Patterns

### Special Files Available via API

These files are generated on-demand when requested:

- `manifest.json` - Project metadata
- `metadata.json` - Generation details  
- `validation_report.json` - Quality report
- `deployment_config.json` - Deployment settings
- `README.md` - Documentation (from capsule.documentation)

### Direct File Access

All files in `source_code` and `tests` dictionaries are directly accessible:

```bash
# Source files
/api/capsules/{id}/files/main.py
/api/capsules/{id}/files/models.py

# Test files  
/api/capsules/{id}/files/tests/test_main.py
/api/capsules/{id}/files/tests/conftest.py
```

## Tips and Best Practices

1. **Always inspect before downloading** - Use the `inspect` command to verify the capsule contains what you need.

2. **Check validation reports** - Look at the validation report to ensure the capsule passed all quality checks.

3. **Use streaming for large capsules** - If a capsule is very large (many files), use the streaming API.

4. **Verify signatures** - For production deployments, verify the capsule signature if available.

5. **Keep capsule IDs** - Store the capsule ID with your deployment for traceability.

## Troubleshooting

### Capsule Not Found
```
‚ùå Capsule capsule-xyz not found
```
Solution: Use `list` command to see available capsules and verify the ID.

### File Not Found in Capsule
```
‚ùå File 'app.py' not found in capsule
```
Solution: Use `inspect` to see actual file names in the capsule.

### Download Fails
- Check network connectivity
- Verify the orchestrator service is running
- Check logs: `docker logs qlp-orchestrator`

## Next Steps

- Run critique on capsules before deployment: [Capsule Critique Guide](./CAPSULE_CRITIC_GUIDE.md)
- Deploy capsules to cloud: [Deployment Guide](./DEPLOYMENT_GUIDE.md)
- Version control for capsules: [Versioning Guide](./CAPSULE_VERSIONING_GUIDE.md)